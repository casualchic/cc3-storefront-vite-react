---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getProducts } from '@/lib/api/products';
import { getCollectionProducts } from '@/lib/api/collections';
import ProductGrid from '@/components/react/ProductGrid';
import FilterSort from '@/components/react/FilterSort';
import type { Product, Category } from '@/lib/db/schema';

const { category } = Astro.params;
const url = new URL(Astro.request.url);
const page = parseInt(url.searchParams.get('page') || '1', 10);
const sortBy = (url.searchParams.get('sort') || 'newest') as 'newest' | 'price-asc' | 'price-desc' | 'name';
const limit = 24;
const offset = (page - 1) * limit;

// Get env from platformProxy in dev, runtime in production
const env = (Astro.locals as any).runtime?.env;
const brandId = Astro.locals.brand || 'casual-chic';

// Fetch products
let products: Product[] = [];
let total = 0;
let categoryData: Category | null = null;

if (env?.DB) {
  if (category) {
    // Fetch collection/category products
    const result = await getCollectionProducts({ env }, {
      handle: category,
      page,
      limit,
      sortBy,
      brandId
    });

    if (result) {
      products = result.products;
      total = result.totalProducts;
      categoryData = result.category;
    }
  } else {
    // Fetch all products
    const result = await getProducts({ env }, { limit, offset, brandId });
    products = result.products;
    total = result.total;
  }
}

const totalPages = Math.ceil(total / limit);

// Page title and description
const pageTitle = categoryData?.name || (category
  ? `${category.charAt(0).toUpperCase() + category.slice(1)} | Shop`
  : 'Shop All Products');
const pageDescription = categoryData?.description || (category
  ? `Browse our curated collection of ${category} items`
  : 'Discover our complete collection of modern, timeless fashion pieces');
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
      <nav class="mb-4 text-sm">
        <ol class="flex items-center space-x-2 text-charcoal">
          <li><a href="/" class="hover:text-primary">Home</a></li>
          <li class="before:content-['/'] before:mx-2">
            <a href="/shop" class="hover:text-primary">Shop</a>
          </li>
          {category && (
            <li class="before:content-['/'] before:mx-2 text-forest font-medium capitalize">
              {category}
            </li>
          )}
        </ol>
      </nav>

      <h1 class="font-heading text-4xl md:text-5xl font-bold text-forest mb-4">
        {category ? (
          <span class="capitalize">{category}</span>
        ) : (
          'Shop All'
        )}
      </h1>

      <p class="font-body text-lg text-charcoal max-w-2xl">
        {pageDescription}
      </p>
    </div>

    <!-- Products Count and Filters Row -->
    <div class="mb-8">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
        <p class="text-sm text-gray-600">
          Showing {products.length > 0 ? offset + 1 : 0}-{Math.min(offset + limit, total)} of {total} products
        </p>
        <FilterSort client:load currentSort={sortBy} />
      </div>
    </div>

    <!-- Product Grid - React Island for interactivity -->
    <ProductGrid products={products} client:load />

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="mt-12 flex justify-center">
        <nav class="flex items-center gap-2">
          <!-- Previous Button -->
          {page > 1 ? (
            <a
              href={`/shop${category ? `/${category}` : ''}?page=${page - 1}`}
              class="px-4 py-2 rounded bg-neutral text-forest hover:bg-primary hover:text-white transition-colors font-body"
            >
              Previous
            </a>
          ) : (
            <span class="px-4 py-2 rounded bg-neutral text-charcoal opacity-50 font-body cursor-not-allowed">
              Previous
            </span>
          )}

          <!-- Page Numbers -->
          {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
            const pageNum = i + 1;
            return (
              <a
                href={`/shop${category ? `/${category}` : ''}?page=${pageNum}`}
                class={`px-4 py-2 rounded font-body transition-colors ${
                  pageNum === page
                    ? 'bg-primary text-white'
                    : 'bg-neutral text-forest hover:bg-sage hover:text-white'
                }`}
              >
                {pageNum}
              </a>
            );
          })}

          {totalPages > 5 && (
            <>
              <span class="px-2 text-charcoal">...</span>
              <a
                href={`/shop${category ? `/${category}` : ''}?page=${totalPages}`}
                class={`px-4 py-2 rounded font-body transition-colors ${
                  totalPages === page
                    ? 'bg-primary text-white'
                    : 'bg-neutral text-forest hover:bg-sage hover:text-white'
                }`}
              >
                {totalPages}
              </a>
            </>
          )}

          <!-- Next Button -->
          {page < totalPages ? (
            <a
              href={`/shop${category ? `/${category}` : ''}?page=${page + 1}`}
              class="px-4 py-2 rounded bg-neutral text-forest hover:bg-primary hover:text-white transition-colors font-body"
            >
              Next
            </a>
          ) : (
            <span class="px-4 py-2 rounded bg-neutral text-charcoal opacity-50 font-body cursor-not-allowed">
              Next
            </span>
          )}
        </nav>
      </div>
    )}

    <!-- Empty State -->
    {products.length === 0 && (
      <div class="text-center py-16">
        <svg
          class="mx-auto h-24 w-24 text-charcoal mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"
          />
        </svg>
        <h2 class="font-heading text-2xl font-bold text-forest mb-2">
          No products found
        </h2>
        <p class="font-body text-charcoal mb-6">
          {env?.DB
            ? 'Check back soon for new arrivals!'
            : 'Connect your D1 database to see products'}
        </p>
        <a
          href="/"
          class="inline-block bg-primary hover:bg-sage text-white font-button px-6 py-3 rounded-lg transition-colors"
        >
          Back to Home
        </a>
      </div>
    )}
  </div>
</BaseLayout>
