---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getProductByHandle } from '@/lib/api/products';

const { handle } = Astro.params;

if (!handle) {
  return Astro.redirect('/404');
}

// Get env from platformProxy in dev, runtime in production
const env = (Astro.locals as any).runtime?.env || Astro.locals.env;

// In development without bindings, show placeholder
let product = null;
if (env?.DB) {
  product = await getProductByHandle({ env }, handle);
}

if (!product && env?.DB) {
  return Astro.redirect('/404');
}

// Mock product for development without D1
const mockProduct = {
  id: '1',
  title: 'Sample Product',
  description: 'This is a placeholder product. Connect D1 database to see real products.',
  handle: handle,
  thumbnail: null,
  price: 4999,
  compare_at_price: 6999,
  inventory_quantity: 10,
  brand_id: 'casual-chic',
  metadata: null,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  synced_at: new Date().toISOString(),
};

const displayProduct = product || mockProduct;
const formattedPrice = (displayProduct.price / 100).toFixed(2);
const formattedComparePrice = displayProduct.compare_at_price
  ? (displayProduct.compare_at_price / 100).toFixed(2)
  : null;
const savings = formattedComparePrice
  ? ((parseFloat(formattedComparePrice) - parseFloat(formattedPrice)) / parseFloat(formattedComparePrice) * 100).toFixed(0)
  : null;
---

<BaseLayout
  title={`${displayProduct.title} | Casual Chic Boutique`}
  description={displayProduct.description || `Shop ${displayProduct.title} at Casual Chic Boutique`}
  ogImage={displayProduct.thumbnail || undefined}
>
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm">
      <ol class="flex items-center space-x-2 text-charcoal">
        <li><a href="/" class="hover:text-primary">Home</a></li>
        <li class="before:content-['/'] before:mx-2">
          <a href="/shop" class="hover:text-primary">Shop</a>
        </li>
        <li class="before:content-['/'] before:mx-2 text-forest font-medium">
          {displayProduct.title}
        </li>
      </ol>
    </nav>

    <!-- Product Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Product Images -->
      <div class="space-y-4">
        <div class="aspect-square bg-neutral rounded-lg overflow-hidden">
          {displayProduct.thumbnail ? (
            <img
              src={displayProduct.thumbnail}
              alt={displayProduct.title}
              class="w-full h-full object-cover"
            />
          ) : (
            <div class="w-full h-full flex items-center justify-center">
              <div class="text-center text-charcoal">
                <svg class="mx-auto h-24 w-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="font-body text-sm">No image available</p>
              </div>
            </div>
          )}
        </div>
      </div>

      <!-- Product Info -->
      <div class="space-y-6">
        <div>
          <h1 class="font-heading text-4xl font-bold text-forest mb-4">
            {displayProduct.title}
          </h1>

          <!-- Price -->
          <div class="flex items-baseline gap-3 mb-6">
            <span class="font-heading text-3xl font-bold text-primary">
              ${formattedPrice}
            </span>
            {formattedComparePrice && (
              <>
                <span class="font-body text-xl text-charcoal line-through">
                  ${formattedComparePrice}
                </span>
                <span class="font-body text-sm font-medium text-secondary bg-neutral px-3 py-1 rounded-full">
                  Save {savings}%
                </span>
              </>
            )}
          </div>

          <!-- Inventory Status -->
          {displayProduct.inventory_quantity !== null && (
            <div class="mb-6">
              {displayProduct.inventory_quantity > 0 ? (
                <p class="font-body text-sm text-sage flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                  </svg>
                  In Stock ({displayProduct.inventory_quantity} available)
                </p>
              ) : (
                <p class="font-body text-sm text-secondary flex items-center gap-2">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                  </svg>
                  Out of Stock
                </p>
              )}
            </div>
          )}
        </div>

        <!-- Description -->
        {displayProduct.description && (
          <div class="border-t border-neutral pt-6">
            <h2 class="font-heading text-xl font-bold text-forest mb-3">
              Description
            </h2>
            <p class="font-body text-charcoal leading-relaxed whitespace-pre-wrap">
              {displayProduct.description}
            </p>
          </div>
        )}

        <!-- Add to Cart Button -->
        <div class="border-t border-neutral pt-6">
          <button
            class="w-full bg-primary hover:bg-sage text-white font-button text-lg px-8 py-4 rounded-lg transition-colors duration-200 min-h-[44px] disabled:opacity-50 disabled:cursor-not-allowed"
            disabled={!displayProduct.inventory_quantity || displayProduct.inventory_quantity <= 0}
          >
            {displayProduct.inventory_quantity && displayProduct.inventory_quantity > 0
              ? 'Add to Cart'
              : 'Out of Stock'}
          </button>
        </div>

        <!-- Product Details -->
        <div class="border-t border-neutral pt-6 space-y-4">
          <h2 class="font-heading text-xl font-bold text-forest mb-3">
            Product Details
          </h2>
          <dl class="font-body text-sm space-y-2">
            <div class="flex justify-between">
              <dt class="text-charcoal">SKU:</dt>
              <dd class="text-forest font-medium">{displayProduct.id}</dd>
            </div>
            {displayProduct.metadata && typeof displayProduct.metadata === 'object' && (
              Object.entries(displayProduct.metadata).map(([key, value]) => (
                <div class="flex justify-between">
                  <dt class="text-charcoal capitalize">{key.replace(/_/g, ' ')}:</dt>
                  <dd class="text-forest font-medium">{String(value)}</dd>
                </div>
              ))
            )}
          </dl>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
